<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>COVIDLYTICS</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='tongquan.css') }}">
    </head>
    <body>
        <nav>
            <div class="logo">
                <a href="index.html">COVIDLYTICS</a>
            </div>
            <div class="nav-items">
                <a href="index.html">T·ªïng quan</a>
                <a href="canhiem.html">D·ª± ƒëo√°n</a>          
        </nav>
        <section class="hero">
            <div class="hero-conatiner">
                        <div class="casep">
                            <p id="updated-time">C·∫≠p nh·∫≠t l√∫c: ...</p>
                        <div class="case-list">
                            <div class="case-item">
                                <h2>S·ªë ca nhi·ªÖm</h2>
                                <p id="infected">ƒêang t·∫£i...</p>
                            </div>
                            <div class="case-item">
                                <h2>S·ªë ca t·ª≠ vong</h2>
                                <p id="deceased">ƒêang t·∫£i...</p>
                            </div>
                            <div class="case-item">
                                <h2>S·ªë ca ph·ª•c h·ªìi</h2>
                                <p id="recovered">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    <div class="column-left">
                        <img src="{{ url_for('static', filename='12.png') }}" alt="illustration" class="hero-image" />
                </div>
            </div>
            <div id="chatbot-container" class="chatbot-closed">
            <button id="chatbot-toggle" class="chatbot-toggle">üí¨</button>
            <div id="chatbot-content" class="chatbot-content">
                <div id="chatbot-messages"></div>
                <div class="chatbot-input-area">
                    <input type="text" id="chatbot-input" placeholder="Nh·∫≠p c√¢u h·ªèi v·ªÅ COVID-19...">
                    <button id="chatbot-send">G·ª≠i</button>
                </div>
            </div>
        </div>
        </section>  
        <script>
        async function fetchCovidData() {
            const url = "https://api.apify.com/v2/key-value-stores/EaCBL1JNntjR3EakU/records/LATEST?disableRedirect=true";
            try {
                const response = await fetch(url);
                const data = await response.json();

                // G√°n d·ªØ li·ªáu t·ª´ API n·∫øu c√≥, n·∫øu kh√¥ng d√πng gi√° tr·ªã m·∫´u
                document.getElementById("infected").textContent = data.infected?.toLocaleString() || "11,619,990";
                document.getElementById("deceased").textContent = data.deceased?.toLocaleString() || "232,400"; // 2% c·ªßa 11,619,990
                document.getElementById("recovered").textContent = data.recovered?.toLocaleString() || "10,457,991"; // 90% c·ªßa 11,619,990

                // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
                const now = new Date();
                const formatted = now.toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" });
                document.getElementById("updated-time").textContent = `C·∫≠p nh·∫≠t l√∫c: ${formatted}`;
            } catch (error) {
                console.error("‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu:", error);
                // D√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu API l·ªói
                document.getElementById("infected").textContent = "11,619,990";
                document.getElementById("deceased").textContent = "232,400";
                document.getElementById("recovered").textContent = "10,457,991";
                const now = new Date();
                const formatted = now.toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" });
                document.getElementById("updated-time").textContent = `C·∫≠p nh·∫≠t l√∫c: ${formatted}`;
            }   
        }

        window.onload = fetchCovidData;

                // START CHATBOT JAVASCRIPT

                // !!! QUAN TR·ªåNG: Thay th·∫ø b·∫±ng API Key TH·∫¨T c·ªßa b·∫°n t·ª´ Google AI Studio !!!
                // KH√îNG ƒê·ªÇ KEY M·∫∂C ƒê·ªäNH HO·∫∂C KEY ƒê√É B·ªä L·ªò/THU H·ªíI.
                const GEMINI_API_KEY = "AIzaSyD3yijlDL9UhMEGmmr4Po654LxlEK-vmEc";

                // Danh s√°ch t·ª´ kh√≥a li√™n quan ƒë·∫øn COVID-19 v√† c√°c tri·ªáu ch·ª©ng
                const covidKeywords = [
                    "covid", "corona", "virus", "d·ªãch b·ªánh", "ca nhi·ªÖm", "t·ª≠ vong", "ph·ª•c h·ªìi",
                    "tri·ªáu ch·ª©ng", "vaccine", "kh·∫©u trang", "gi√£n c√°ch", "x√©t nghi·ªám", "ƒë·∫°i d·ªãch",
                    "bi·∫øn th·ªÉ", "omicron", "delta", "ti√™m ch·ªßng", "ph√≤ng ng·ª´a", "l√¢y nhi·ªÖm", "ca t·ª≠ vong", "ca ph·ª•c h·ªìi",
                    // C√°c t·ª´ kh√≥a li√™n quan ƒë·∫øn tri·ªáu ch·ª©ng
                    "s·ªët", "ho", "ƒëau h·ªçng", "m·∫•t v·ªã gi√°c", "m·∫•t kh·ª©u gi√°c", "kh√≥ th·ªü", "ƒëau ƒë·∫ßu", "ƒëau nh·ª©c c∆° th·ªÉ",
                    "m·ªát m·ªèi", "bu·ªìn n√¥n", "ti√™u ch·∫£y", "vi√™m ph·ªïi", "ngh·∫πt m≈©i", "ch·∫£y n∆∞·ªõc m≈©i",
                    // C√°c t·ª´ chung gi√∫p nh·∫≠n di·ªán c√¢u h·ªèi v·ªÅ COVID-19/tri·ªáu ch·ª©ng
                    "t√¨nh h√¨nh", "th√¥ng tin", "c·∫≠p nh·∫≠t", "bao nhi√™u", "l√† g√¨", "ph·∫£i l√†m g√¨", "nguy hi·ªÉm",
                    "ph√¢n bi·ªát", "l√†m sao bi·∫øt", "b·ªã covid", "test", "ki·ªÉm tra", "ƒëi·ªÅu tr·ªã", "ph√°c ƒë·ªì"
                ];

                // H√†m ki·ªÉm tra xem c√¢u h·ªèi c√≥ li√™n quan ƒë·∫øn COVID-19 kh√¥ng
                function isCovidRelated(message) {
                    const lowerMessage = message.toLowerCase();
                    // S·ª≠ d·ª•ng .some() ƒë·ªÉ ki·ªÉm tra n·∫øu tin nh·∫Øn ch·ª©a B·∫§T K·ª≤ t·ª´ kh√≥a n√†o
                    return covidKeywords.some(keyword => lowerMessage.includes(keyword));
                }

                // H√†m g·ªçi API c·ªßa Gemini
                async function callGeminiApi(message) {
                    // Ki·ªÉm tra API Key: Ch·ªâ c·∫ßn ki·ªÉm tra xem key c√≥ t·ªìn t·∫°i v√† kh√¥ng r·ªóng
                    if (!GEMINI_API_KEY || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY === "YOUR_ACTUAL_GEMINI_API_KEY_HERE") {
                        console.error("L·ªói: Vui l√≤ng ƒë·∫∑t Gemini API Key c·ªßa b·∫°n.");
                        return "L·ªói c·∫•u h√¨nh: Vui l√≤ng ki·ªÉm tra Gemini API Key c·ªßa b·∫°n.";
                    }

                    // C·∫≠p nh·∫≠t API_ENDPOINT ƒë·ªÉ s·ª≠ d·ª•ng m√¥ h√¨nh gemini-2.0-flash
                    const API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                    try {
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        // PROMPT ƒê√É ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A V√Ä T·ªêI ∆ØU H√ìA
                                        text: `B·∫°n l√† chatbot chuy√™n v·ªÅ COVID-19 v√† c√°c tri·ªáu ch·ª©ng li√™n quan. Tr·∫£ l·ªùi c√¢u h·ªèi sau m·ªôt c√°ch ng·∫Øn g·ªçn, ch√≠nh x√°c v√† ch·ªâ cung c·∫•p th√¥ng tin li√™n quan tr·ª±c ti·∫øp ƒë·∫øn COVID-19 ho·∫∑c c√°c tri·ªáu ch·ª©ng c·ªßa n√≥.
                                        N·∫øu c√¢u h·ªèi y√™u c·∫ßu c·∫≠p nh·∫≠t t√¨nh h√¨nh ho·∫∑c s·ªë li·ªáu chung v·ªÅ COVID-19 (v√≠ d·ª•: "c·∫≠p nh·∫≠t ca nhi·ªÖm", "t√¨nh h√¨nh d·ªãch"), h√£y cung c·∫•p th√¥ng tin t·ªïng quan b·∫°n c√≥ v·ªÅ COVID-19.
                                        N·∫øu c√¢u h·ªèi ho√†n to√†n kh√¥ng li√™n quan ƒë·∫øn COVID-19 ho·∫∑c c√°c tri·ªáu ch·ª©ng c·ªßa n√≥, h√£y l·ªãch s·ª± th√¥ng b√°o r·∫±ng b·∫°n ch·ªâ c√≥ th·ªÉ h·ªó tr·ª£ v·ªÅ ch·ªß ƒë·ªÅ n√†y.
                                        C√¢u h·ªèi: ${message}`
                                    }]
                                }]
                            })
                        });

                        const data = await response.json();

                        // Ki·ªÉm tra l·ªói t·ª´ API (v√≠ d·ª•: 400 Bad Request, 403 Forbidden)
                        if (!response.ok) {
                            console.error("L·ªói t·ª´ Gemini API:", response.status, data);
                            // C·ªë g·∫Øng l·∫•y th√¥ng b√°o l·ªói t·ª´ Gemini n·∫øu c√≥
                            if (data && data.error && data.error.message) {
                                return `L·ªói API: ${data.error.message}. Vui l√≤ng ki·ªÉm tra API Key v√† h·∫°n ch·∫ø truy c·∫≠p.`;
                            }
                            return `Xin l·ªói, c√≥ l·ªói khi g·ªçi API Gemini (${response.status}). Vui l√≤ng th·ª≠ l·∫°i.`;
                        }


                        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                            return data.candidates[0].content.parts[0].text;
                        } else {
                            console.warn("Kh√¥ng c√≥ ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ Gemini API:", data);
                            return "Xin l·ªói, t√¥i kh√¥ng th·ªÉ t√¨m th·∫•y th√¥ng tin ph√π h·ª£p t·ª´ Gemini API. Vui l√≤ng th·ª≠ l·∫°i c√¢u h·ªèi kh√°c.";
                        }
                    } catch (error) {
                        console.error("L·ªói khi g·ªçi API Gemini:", error);
                        return "Xin l·ªói, t√¥i g·∫∑p l·ªói khi x·ª≠ l√Ω c√¢u h·ªèi c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i.";
                    }
                }

                // S·ª± ki·ªán khi ng∆∞·ªùi d√πng nh·∫•n n√∫t g·ª≠i tin nh·∫Øn
                document.getElementById('chatbot-send').addEventListener('click', async function() {
                    const input = document.getElementById('chatbot-input');
                    const message = input.value.trim();
                    if (message) {
                        const messagesDisplay = document.getElementById('chatbot-messages');

                        // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
                        const userMessageDiv = document.createElement('div');
                        userMessageDiv.textContent = `B·∫°n: ${message}`;
                        userMessageDiv.classList.add('user-message');
                        messagesDisplay.appendChild(userMessageDiv);
                        input.value = ''; // X√≥a n·ªôi dung input
                        messagesDisplay.scrollTop = messagesDisplay.scrollHeight; // Cu·ªôn xu·ªëng cu·ªëi

                        const lowerMessage = message.toLowerCase();

                        // X·ª≠ l√Ω c√°c c√¢u h·ªèi chung v·ªÅ t√¨nh h√¨nh/c·∫≠p nh·∫≠t COVID-19 ngay t·∫°i client
                        // ƒêi·ªÅu n√†y gi√∫p ph·∫£n h·ªìi nhanh m√† kh√¥ng c·∫ßn g·ªçi API
                        if (lowerMessage.includes("c·∫≠p nh·∫≠t ca nhi·ªÖm") || lowerMessage.includes("t√¨nh h√¨nh d·ªãch") || lowerMessage.includes("t√¨nh h√¨nh covid")) {
                            const botMessageDiv = document.createElement('div');
                            botMessageDiv.textContent = "Bot: ƒê·ªÉ c·∫≠p nh·∫≠t s·ªë li·ªáu COVID-19, t√¥i c·∫ßn b·∫°n c·ª• th·ªÉ h∆°n v·ªÅ qu·ªëc gia ho·∫∑c lo·∫°i th√¥ng tin b·∫°n mu·ªën (v√≠ d·ª•: ca nhi·ªÖm m·ªõi, t·ªïng s·ªë ca, ca t·ª≠ vong).";
                            botMessageDiv.classList.add('bot-message');
                            messagesDisplay.appendChild(botMessageDiv);
                            messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
                            return; // D·ª´ng x·ª≠ l√Ω t·∫°i ƒë√¢y
                        }

                        // Ki·ªÉm tra xem c√¢u h·ªèi c√≥ li√™n quan ƒë·∫øn COVID-19/tri·ªáu ch·ª©ng kh√¥ng.
                        // N·∫øu KH√îNG li√™n quan, bot s·∫Ω tr·∫£ l·ªùi th√¥ng b√°o gi·ªõi h·∫°n ch·ªß ƒë·ªÅ.
                        // N·∫øu C√ì li√™n quan, s·∫Ω ti·∫øp t·ª•c g·ªçi Gemini API.
                        if (!isCovidRelated(message)) {
                            const botMessageDiv = document.createElement('div');
                            botMessageDiv.textContent = "Bot: Xin l·ªói, t√¥i ch·ªâ tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ COVID-19 v√† c√°c tri·ªáu ch·ª©ng li√™n quan. Vui l√≤ng h·ªèi v·ªÅ ch·ªß ƒë·ªÅ n√†y!";
                            botMessageDiv.classList.add('bot-message');
                            messagesDisplay.appendChild
                            messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
                            return; // D·ª´ng x·ª≠ l√Ω t·∫°i ƒë√¢y
                        }

                        // N·∫øu c√¢u h·ªèi ƒë√£ qua c√°c b·ªô l·ªçc v√† ƒë∆∞·ª£c x√°c ƒë·ªãnh l√† li√™n quan, g·ªçi Gemini API
                        const botResponse = await callGeminiApi(message);
                        const botMessageDiv = document.createElement('div');
                        botMessageDiv.textContent = `Bot: ${botResponse}`;
                        botMessageDiv.classList.add('bot-message');
                        messagesDisplay.appendChild(botMessageDiv);
                        messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
                    }
                });

                // S·ª± ki·ªán khi ng∆∞·ªùi d√πng nh·∫•n Enter trong √¥ input
                document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('chatbot-send').click(); // K√≠ch ho·∫°t s·ª± ki·ªán click n√∫t g·ª≠i
                    }
                });

                // S·ª± ki·ªán ƒë√≥ng/m·ªü chatbot
                document.getElementById('chatbot-toggle').addEventListener('click', function() {
                    const container = document.getElementById('chatbot-container');
                    container.classList.toggle('chatbot-closed');
                });
                 async function fetchCovidData() {
                const url = "https://api.apify.com/v2/key-value-stores/EaCBL1JNntjR3EakU/records/LATEST?disableRedirect=true";
                    try {
                        const response = await fetch(url);
                        const data = await response.json();

                        // Ki·ªÉm tra c√≥ d·ªØ li·ªáu th·∫≠t kh√¥ng
                        console.log("‚úÖ D·ªØ li·ªáu l·∫•y ƒë∆∞·ª£c t·ª´ API:", data);

                        const infected = data.infected || data.totalCases || 0;
                        const deceased = data.deceased || data.deaths || 0;
                        const recovered = data.recovered || data.recoveredCases || 0;

                        document.getElementById("infected").textContent = infected.toLocaleString("vi-VN");
                        document.getElementById("deceased").textContent = deceased.toLocaleString("vi-VN");
                        document.getElementById("recovered").textContent = recovered.toLocaleString("vi-VN");

                        const now = new Date();
                        const formatted = now.toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" });
                        document.getElementById("updated-time").textContent = `C·∫≠p nh·∫≠t l√∫c: ${formatted}`;
                    } catch (error) {
                        console.error("‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu COVID:", error);
                        document.getElementById("infected").textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c";
                        document.getElementById("deceased").textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c";
                        document.getElementById("recovered").textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c";
                        document.getElementById("updated-time").textContent = "Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c";
                    }
                }

                    window.onload = fetchCovidData;

        </script>
    </body>
</html>